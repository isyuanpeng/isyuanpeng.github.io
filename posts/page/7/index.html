<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Posts | Isyuanpeng</title>
<meta name="keywords" content="" />
<meta name="description" content="Posts - Isyuanpeng">
<meta name="author" content="">
<link rel="canonical" href="https://isyuanpeng.github.io/posts/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7bdb1411b29ec9fed2b6395a081eabcb3262e7311bda855249d433c8b30a926e.css" integrity="sha256-e9sUEbKeyf7StjlaCB6ryzJi5zEb2oVSSdQzyLMKkm4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://isyuanpeng.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://isyuanpeng.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://isyuanpeng.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://isyuanpeng.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://isyuanpeng.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.140.0">
<link rel="alternate" type="application/rss+xml" href="https://isyuanpeng.github.io/posts/index.xml">
<link rel="alternate" hreflang="en" href="https://isyuanpeng.github.io/posts/" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Posts" />
<meta property="og:description" content="The blog of YuanPeng." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://isyuanpeng.github.io/posts/" /><meta property="og:image" content="https://isyuanpeng.github.io/papermod-cover.png"/>

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://isyuanpeng.github.io/papermod-cover.png"/>

<meta name="twitter:title" content="Posts"/>
<meta name="twitter:description" content="The blog of YuanPeng."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://isyuanpeng.github.io/posts/"
    }
  ]
}
</script>
</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://isyuanpeng.github.io/" accesskey="h" title="Isyuanpeng (Alt + H)">Isyuanpeng</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://isyuanpeng.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://isyuanpeng.github.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://isyuanpeng.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://isyuanpeng.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://isyuanpeng.github.io/series/" title="Series">
                    <span>Series</span>
                </a>
            </li>
            <li>
                <a href="https://isyuanpeng.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="https://isyuanpeng.github.io/">Home</a></div>
  <h1>Posts</h1>
</header>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>记一次数据库膨胀问题的解决过程
    </h2>
  </header>
  <section class="entry-content">
    <p>问题描述 表中记录了图片的base64 表大概有200w数据 占用了300G左右的空间 问题解决 查询了wiki和咨询了总部的pg数据库的同事得知了pg数据库存在膨胀的问题，即垃圾清理问题。所以及时删除了数据，空间也不会得到释放，只有手动进行垃圾清理后空间才能够得到释放，所以根据总部同事提供的排查方案，首先进行数据膨胀的排查。
pg数据库膨胀的问题排查 通过排查后发现，真正大的表是pg_toast_oid表，并且根据排查也发现其dead_tup比较大，实际上这是pg数据库存储大型数据的逻辑toast，后面知识点归纳也会提到这一点。pg_toast_oid表我们分析可知为表中的base64图片的压缩切片存储。
解决方案 大数据量的表VACUUM FULL很慢并且会锁表(VACUUM FULL的原理是复制新表，然后删除旧表)，所以直接在业务空闲期进行表的删除和重建。（由于数据已经实时的推送给了三方，在中间数据库中也有数据存储，所以这里没有进行备份，选择了直接删除。删除的时候对于这种大数据的表要进行批量删除，先将部分数据删除，然后在删除整个表，避免长时间的执行删除命令导致业务中断的时间过长。） 引申出来的一点关于数据库操作的建议：尽量避免长连接的操作，如果数据库的并发量比较高，长连接一直占用，将会导致数据库连接不够用，从而产生报错。 后续的过程中删除保留时间过长的数据，并且执行VACUUM FULL命令(kettle流程深夜执行) 此问题产生的思考 BASE64的图片不要存库。选择图片存储地址等方案。 所有的东西设计之初就要想好，并且日后有优化的想法时第一时间优化。 知识点总结归纳 https://juejin.cn/post/7016165148020703246
事务特性-ACID 原子性（Atomicity）：对数据库的操作要么执行，要么不执行。 一致性（Consistency）：不管操作是否执行，数据保持不变。 隔离性（Isolation）：多个事务并发访问，相互隔离。 持久性（Durability）：事务操作完成后，将永久保存。 事务并发产生的问题 脏读: 一个事务读取到了另一个未提交事务修改过的数据 不可重复读：同一个事务内，前后多次读取，读取到的数据内容不一致 幻读: 如果一个事务先根据某些搜索条件查询出一些记录，在该事务未提交时，另一个事务写入了一些符合那些搜索条件的记录（如insert、delete、update），就意味着发生了幻读。 MVCC-Multi-Version Concurrency Control Multi-Version Concurrency Control，多版本并发控制
通俗的讲，数据库中同时存在多个版本的数据，并不是整个数据库的多个版本，而是某一条记录的多个版本同时存在，在某个事务对其进行操作的时候，需要查看这一条记录的隐藏列事务版本id，比对事务id并根据事物隔离级别去判断读取哪个版本的数据。
MVCC实现的关键点 事务版本号： 事务每次开启前，都会从数据库获得一个自增长的事务ID，可以从事务ID判断事务的执行先后顺序。这就是事务版本号。 &#43; 有关版本号的经验和思考： 版本号多用于控制并发，常用于乐观锁来解决并发问题，如MySQL的乐观锁解决并发。其基本做法是在数据库的表中引入版本的字段(version)，数据每进行一次更新，version&#43;1，当提交更新的时候，比对版本号&#43;1是否相等，不相等则认为当前数据是过期数据。
隐式字段：以MySQL为例，InnoDB存储引擎
trx_id: 记录操作数据事务的事务id roll_pointer: 指针，指向回滚的undo日志 row_id: 如果没主键和非NULL惟一键，有该主键列 undo log: 回滚日志
版本链：通过roll_pointer来指向undo_log
快照读和当前读：
快照读：读的是记录数据的可见版本 当前读：读的是记录数据的最新版本 ReadView：事务执行SQL时产生的读视图
PostgreSQL toast https://zhmin.github.io/posts/postgresql-toast/
toast说白了就是为了存储大型数据，表中的某个列的数据如果过大，则压缩，切分，放到toast表中，在之前问题的排查中，也可以看到真正数据量大的并不是数据存储的本表，而是pg_toast_oid表。
PostgreSQL VACUUM https://www.cnblogs.com/dbadaily/p/vacuum1.html https://www.cnblogs.com/dbadaily/p/vacuum2.html https://www.cnblogs.com/dbadaily/p/vacuum3.html https://www.cnblogs.com/dbadaily/p/vacuum4.html https://www.cnblogs.com/dbadaily/p/vacuum5.html
推荐阅读（我没读） https://www.interdb.jp/pg/ </p>
  </section>
  <footer class="entry-footer">&lt;span title=&#39;2022-02-25 13:44:17 &#43;0800 &#43;0800&#39;&gt;February 25, 2022&lt;/span&gt;&amp;nbsp;·&amp;nbsp;1 min&amp;nbsp;·&amp;nbsp;YuanPeng11</footer>
  <a class="entry-link" aria-label="post link to 记一次数据库膨胀问题的解决过程" href="https://isyuanpeng.github.io/posts/question/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E8%86%A8%E8%83%80%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>IDEA&#43;EasyCode实现自动生成代码
    </h2>
  </header>
  <section class="entry-content">
    <p>需求 对于增删改查类的代码，每次都要写很多重复的代码，所以考虑使用自动生成代码来减少重复工作。
自动生成代码的现状 目前有多种方式可以自动生成代码:
将模板引擎集成到项目中，通过代码的形式自动生成代码，此种方法和项目耦合度较高，对项目由侵入性
在线网站自动生成代码，使用互联网，安全性较低
IDEA&#43;groovy方法，目前了解到生成的代码比较简单，定制化程度不高
IDEA插件生成，一般插件也都是以模板引擎为基础，进行代码的生成
最后选择了第四种，IDEA插件的方式，插件使用的是EasyCode, 基于velocity模板引擎。 &gt; https://gitee.com/makejava/EasyCode
Velocity(速度)语法 比较精简的一种语言，关键字不多，和代码混合使用。教程：https://www.cnblogs.com/hduwbf/p/6201731.html
EasyCode 我的模板(具有个人风格，可以进行修改使用) Controller 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 ##导入宏定义 $!{init.vm} $!{define.vm} ##保存文件（宏定义） #save(&#34;/controller/$!{workPath}&#34;, &#34;Controller.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;controller$!{workPackage}&#34;) $!{autoImport.vm} import io.swagger.annotations.ApiOperation; import $!{tableInfo.savePackageName}.service$!{workPackage}.$!{serviceType}; import $!{tableInfo.savePackageName}.dto$!{workPackage}.$!{dtoType}; import $!{tableInfo.savePackageName}.vo$!{workPackage}.$!{voType}; import org.springframework.web.bind.annotation.*; import io.swagger.annotations.Api; import org.apache.commons.lang3.StringUtils; import javax.annotation.Resource; import java.util.List; ##表注释（宏定义） #classNotes(&#34;表控制层&#34;) @Api(tags = &#34;$!{tableInfo.comment}&#34;) @RestController @RequestMapping(&#34;$!entityName&#34;) public class $!apiType { @Resource private $!serviceType $!serviceName; /** * 分页查询所有数据 * * @param query 查询实体 * @return 所有数据 */ @PostMapping(&#34;/queryPage&#34;) @ApiOperation(&#34;按字段条件分页查询$!{tableInfo.comment}&#34;) public BaseResult&lt;PageVo&lt;$!voType&gt;&gt; query$!{entityType}ByPage(@RequestBody $!{queryType} query) { return $!{serviceName}.queryByPage(query); } /** * 通过主键查询多条数据 * * @param query 查询实体 * @return 多条数据 */ @PostMapping(&#34;/query&#34;) @ApiOperation(&#34;根据Id查询$!{tableInfo.comment}&#34;) public BaseResult&lt;List&lt;$!voType&gt;&gt; query(@RequestBody $!{queryType} query) { return $!{serviceName}.queryByCondition(query); } /** * 新增数据 * * @param dto 实体对象 * @return 新增结果 */ @PostMapping(&#34;/save&#34;) @ApiOperation(&#34;新增$!{tableInfo.comment}数据&#34;) public BaseResult&lt;Object&gt; save(@RequestBody $!{dtoType} dto) { //数据校验 if (StringUtils.isBlank(dto.getName())) { return new BaseResult&lt;&gt;(ResponseEnum.NO_ARGS.getCode(), ResponseEnum.NO_ARGS.getMessage()); } if ($!{serviceName}.isExist(dto)) { return new BaseResult&lt;&gt;(ResponseEnum.REPEAT.getCode(), ResponseEnum.REPEAT.getMessage()); } return $!{serviceName}.save(dto); } /** * 修改数据 * * @param dto 实体对象 * @return 修改结果 */ @PostMapping(&#34;/update&#34;) @ApiOperation(&#34;更新$!{tableInfo.comment}&#34;) public BaseResult&lt;Object&gt; update($!{dtoType} dto) { //数据校验 if (StringUtils.isBlank(dto.getName())) { return new BaseResult&lt;&gt;(ResponseEnum.NO_ARGS.getCode(), ResponseEnum.NO_ARGS.getMessage()); } return $!{serviceName}.update(dto); } /** * 删除多条数据 * * @param ids 主键ids * @return 删除结果 */ @PostMapping(&#34;/delete&#34;) @ApiOperation(&#34;根据Id软删除$!{tableInfo.comment}数据&#34;) public BaseResult&lt;List&lt;SingleResult&gt;&gt; deleteByRowIds(List&lt;Long&gt; ids) { List&lt;SingleResult&gt; result = new ArrayList&lt;&gt;(); ids.forEach(x -&gt; { // 数据校验 if (!$!{serviceName}.isExistById(x)) { result.add(SingleResult.successBuild(x.toString())); } else { result.add($!{serviceName}.deleteById(x)); } }); return BaseResult.success(result); } } Entity 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 $!{init.vm} $!{define.vm} ##保存文件（宏定义） #save(&#34;/entity$!{workPath}&#34;, &#34;.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;entity$!{workPackage}&#34;) import io.swagger.annotations.ApiModel; import io.swagger.annotations.ApiModelProperty; import lombok.Data; import javax.persistence.*; import java.io.Serializable; import java.util.Date; ##表注释（宏定义） #classNotes(&#34;&#34;) @Data ##@ApiModel(value=&#34;$tableInfo.savePackageName.replace(&#34;.&#34;,&#34;-&#34;)-entity$!{workCommon}-$!{entityType}&#34;) @ApiModel(value=&#34;$!{tableInfo.comment}&#34;) @Table(name = &#34;$!{tableInfo.obj.name}&#34;) public class $!entityType implements Serializable { private static final long serialVersionUID = 1L; ## 主键列 #foreach($column in $tableInfo.pkColumn) /** * $!column.comment */ @Id @GeneratedValue(strategy=GenerationType.IDENTITY) @Column(name = &#34;$!{column.obj.name}&#34;) @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($column.type) $!column.name; #end ## 其他列 #foreach($column in $tableInfo.otherColumn) /** * $!{column.comment} */ @Column(name = &#34;$!{column.obj.name}&#34;) @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($!column.type) $!column.name; #end } Service 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ##导入宏定义 $!{init.vm} $!{define.vm} ##保存文件（宏定义） #save(&#34;/service$!{workPath}&#34;, &#34;Service.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;service$!{workPackage}&#34;) $!{autoimpot.vm} ##表注释（宏定义） #classNotes(&#34;表服务接口&#34;) public interface $!serviceType { BaseResult&lt;PageVo&lt;$!{voType}&gt;&gt; queryByPage($!{queryType} query); BaseResult&lt;List&lt;$!{voType}&gt;&gt; queryByCondition($!{queryType} query); BaseResult&lt;Object&gt; save($!{dtoType} dto); BaseResult&lt;List&lt;SingleResult&gt;&gt; saveBatch(List&lt;$!{dtoType}&gt; dtos); BaseResult&lt;Object&gt; update($!{dtoType} dto); BaseResult&lt;List&lt;SingleResult&gt;&gt; updateBatch(List&lt;$!{dtoType}&gt; dtos); SingleResult deleteById(Long id); boolean isExist($!{dtoType} dto); boolean isExistById(Long id); } ServiceImpl 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 ##导入宏定义 $!{init.vm} $!{define.vm} ##保存文件（宏定义） #save(&#34;/service/impl/$!{workPath}&#34;, &#34;ServiceImpl.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;service.impl$!{workPackage}&#34;) $!{autoimport.vm} import org.apache.commons.lang3.StringUtils; import javax.transaction.Transactional; import $!{tableInfo.savePackageName}.entity$!{workPackage}.$!{entityType}; import javax.persistence.criteria.Predicate; #classNotes(&#34;表服务实现类&#34;) @Service public class $!{serviceImplType} implements $!{serviceType} { @Resource private $!{repositoryType} $!{repositoryName}; /** * 查询多条数据 * * @param query 查询参数 * @return 实例对象 */ @Override public BaseResult&lt;List&lt;$!{voType}&gt;&gt; queryByCondition($!{queryType} query) { List&lt;$!{tableInfo.name}&gt; items = $!{repositoryName}.findAll(getWhereClause(query)); return BaseResult.success(BaseConverter.convertAll(items, $!{voType}.class)); } /** * 分页查询 * * @param query 筛选条件 * @return 查询结果 */ @Override public BaseResult&lt;PageVo&lt;$!voType&gt;&gt; queryByPage($!{queryType} query) { try { Sort sort = Sort.by(&#34;desc&#34;.equals(query.getSortOrder()) ? Sort.Direction.DESC : Sort.Direction.ASC, query.getSortField()); Pageable pageable = PageRequest.of(query.getPageNo() - 1, (query.getPageSize()), sort); Page&lt;$!{tableInfo.name}&gt; page = $!{repositoryName}.findAll(getWhereClause(query), pageable); return BaseResult.success(BaseConverter.convertPage(page, $!{voType}.class)); } catch (Exception e) { return new BaseResult&lt;&gt;(&#34;-1&#34;, &#34;查询分页失败&#34;); } } /** * 新增数据 * * @param dto dto对象 * @return vo $!voName */ @Override public BaseResult&lt;Object&gt; save($!dtoType dto) { try { $!{tableInfo.name} entity = BaseConverter.convert(dto, $!{tableInfo.name}.class); $!{repositoryName}.save(entity); } catch (Exception e) { return new BaseResult&lt;&gt;(&#34;-1&#34;, &#34;保存失败&#34;); } return new BaseResult&lt;&gt;(); } /** * 批量新增数据 * * @param dtos dto对象 * @return BaseResult */ @Override public BaseResult&lt;List&lt;SingleResult&gt;&gt; saveBatch(List&lt;$!dtoType&gt; dtos) { try { List&lt;$!{tableInfo.name}&gt; entitys = BaseConverter.convertAll(dtos, $!{tableInfo.name}.class); $!{repositoryName}.saveAll(entitys); } catch (Exception e) { return new BaseResult&lt;&gt;(&#34;-1&#34;, &#34;保存失败&#34;); } return new BaseResult&lt;&gt;(); } /** * 修改数据 * * @param dto dto对象 * @return BaseResult */ @Override @Transactional public BaseResult&lt;Object&gt; update($!dtoType dto) { try { $!{tableInfo.name} entity = BaseConverter.convert(dto, $!{tableInfo.name}.class); $!{repositoryName}.save(entity); } catch (Exception e) { return new BaseResult&lt;&gt;(&#34;-1&#34;, &#34;更新失败&#34;); } return new BaseResult&lt;&gt;(); } /** * 批量修改数据 * * @param dtos dto对象 * @return 实例对象 */ @Override @Transactional public BaseResult&lt;List&lt;SingleResult&gt;&gt; updateBatch(List&lt;$!dtoType&gt; dtos) { try { List&lt;$!{tableInfo.name}&gt; entitys = BaseConverter.convertAll(dtos, $!{tableInfo.name}.class); $!{repositoryName}.saveAll(entitys); } catch (Exception e) { return new BaseResult&lt;&gt;(&#34;-1&#34;, &#34;批量更新失败&#34;); } return new BaseResult&lt;&gt;(); } /** * 通过主键删除数据 * * @param id 主键 * @return 是否成功 */ @Override @Transactional public SingleResult deleteById(Long id) { try { $!{repositoryName}.updateDeletedById(id); } catch (Exception e) { return SingleResult.build(id.toString(), &#34;false&#34;, &#34;删除异常&#34;); } return SingleResult.successBuild(id.toString()); } @Override public boolean isExist($!{dtoType} dto) { Integer exist = $!{repositoryName}.isExist(dto.getName()); return null != exist; } @Override public boolean isExistById(Long id) { Integer exist = $!{repositoryName}.isExistById(id); return null != exist; } private Specification&lt;$!{tableInfo.name}&gt; getWhereClause($!{queryType} query) { return (Specification&lt;$!{tableInfo.name}&gt;) (root, criteriaQuery, criteriaBuilder) -&gt; { List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;(); if (StringUtils.isNotBlank(query.getName())) { predicates.add(criteriaBuilder.like(root.get(&#34;name&#34;), &#34;%&#34; &#43; query.getName() &#43; &#34;%&#34;)); } if (ObjectUtils.isNotEmpty(query.getCreatedTime())) { //大于等于开始时间 predicates.add(criteriaBuilder.greaterThanOrEqualTo(root.get(&#34;createTime&#34;), DateUtil.parse(query.getCreatedTime()))); } if (ObjectUtils.isNotEmpty(query.getCreatedTime())) { //小于等于结束时间 predicates.add(criteriaBuilder.lessThanOrEqualTo(root.get(&#34;createTime&#34;), DateUtil.parse(query.getCreatedTime()))); } return criteriaBuilder.and(predicates.toArray(new Predicate[0])); }; } } VO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 $!{init.vm} $!{define.vm} ##保存文件 #save(&#34;/vo$!{workPath}&#34;, &#34;VO.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;vo$!{workPackage}&#34;) ##自动导入包（全局变量） $!{autoImport.vm} import java.util.Date; ##表注释（宏定义） #classNotes(&#34;&#34;) @Data @ApiModel(value=&#34;$tableInfo.savePackageName.replace(&#34;.&#34;,&#34;-&#34;)-dto$!{workCommon}-$!{voType}&#34;) public class $!voType implements Serializable { private static final long serialVersionUID = 1L; ## 主键列 #foreach($column in $tableInfo.pkColumn) /** * $!column.comment */ @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($column.type) $!column.name; #end ## 其他列 #foreach($column in $tableInfo.otherColumn) /** * $!{column.comment} */ @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($!column.type) $!column.name; #end } DTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 $!{init.vm} $!{define.vm} ##保存文件 #save(&#34;/dto$!{workPath}&#34;, &#34;DTO.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;dto$!{workPackage}&#34;) ##自动导入包（全局变量） $!{autoImport.vm} import io.swagger.annotations.ApiModel; import io.swagger.annotations.ApiModelProperty; import java.io.Serializable; import lombok.Data; import java.util.Date; ##表注释（宏定义） #classNotes(&#34;&#34;) @Data @ApiModel(value=&#34;$tableInfo.savePackageName.replace(&#34;.&#34;,&#34;-&#34;)-dto$!{workCommon}-$!{dtoType}&#34;) public class $!dtoType implements Serializable { private static final long serialVersionUID = 1L; ## 主键列 #foreach($column in $tableInfo.pkColumn) /** * $!column.comment */ @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($column.type) $!column.name; #end ## 其他列 #foreach($column in $tableInfo.otherColumn) /** * $!{column.comment} */ @ApiModelProperty(value = &#34;$!column.comment&#34;) private $!tool.getClsNameByFullName($!column.type) $!column.name; #end } Repository JPA 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ##导入宏定义 $!{init.vm} $!{define.vm} ##保存文件（宏定义） #save(&#34;/repository/$!{workPath}&#34;, &#34;Repository.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;repository$!{workPackage}&#34;) import com.javahik.hiklife.easycode.entity.$!{tableInfo.name}; import org.springframework.data.jpa.repository.JpaRepository; import org.springframework.data.jpa.repository.JpaSpecificationExecutor; import org.springframework.data.jpa.repository.Modifying; import org.springframework.data.jpa.repository.Query; import org.springframework.stereotype.Repository; ##表注释（宏定义） #classNotes(&#34;表数据库访问层&#34;) @Repository public interface $!{repositoryType} extends JpaRepository&lt;$!{tableInfo.name}, String&gt;, JpaSpecificationExecutor&lt;$!{tableInfo.name}&gt; { @Modifying @Query(nativeQuery = true, value = &#34;update $!{tableInfo.name} set deleted = &#39;1&#39; where id = ?1&#34;) void updateDeletedById(Long id); @Query(nativeQuery = true, value = &#34;select 1 from $!{tableInfo.name} where name = ?1 limit 1&#34;) Integer isExist(String name); @Query(nativeQuery = true, value = &#34;select 1 from $!{tableInfo.name} where id = ?1 limit 1&#34;) Integer isExistById(Long id); } QueryDTO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 $!{init.vm} $!{define.vm} ##保存文件 #save(&#34;/dto$!{workPath}&#34;, &#34;Query.java&#34;) ##包路径（宏定义） #setPackageSuffix(&#34;dto$!{workPackage}&#34;) ##自动导入包（全局变量） $!{autoImport.vm} import io.swagger.annotations.ApiModel; import io.swagger.annotations.ApiModelProperty; import java.io.Serializable; import lombok.Data; import java.util.Date; ##表注释（宏定义） #classNotes(&#34;查询类&#34;) @Data public class $!{queryType} implements Serializable { private static final long serialVersionUID = 1L; private Integer pageNo = 1; private Integer pageSize = 20; private String sortField = &#34;createDate&#34;; private String sortOrder = &#34;desc&#34;; private String createdTime; private String name; } Define 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 ##（Velocity宏定义） ##定义设置表名后缀的宏定义，调用方式：#setTableSuffix(&#34;Test&#34;) #macro(setTableSuffix $suffix) #set($tableName = $!tool.append($tableInfo.name, $suffix)) #end ##定义设置包名后缀的宏定义，调用方式：#setPackageSuffix(&#34;Test&#34;) #macro(setPackageSuffix $suffix) #if($suffix!=&#34;&#34;)package #end#if($tableInfo.savePackageName!=&#34;&#34;)$!{tableInfo.savePackageName}.#{end}$!suffix; #end ##定义直接保存路径与文件名简化的宏定义，调用方式：#save(&#34;/entity&#34;, &#34;.java&#34;) #macro(save $path $fileName) $!callback.setSavePath($tool.append($tableInfo.savePath, $path)) $!callback.setFileName($tool.append($tableInfo.name, $fileName)) #end ## 自定义entity、Mapper、Service、Api、DTO、VO的名字减少拼接，增加重用性 #set($entityType = $!tool.firstUpperCase($!tableInfo.name)) #set($entityName = $!tool.firstLowerCase($!tableInfo.name)) #set($mapperType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;Mapper&#34;)) #set($mapperName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;Mapper&#34;)) #set($repositoryType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;Repository&#34;)) #set($repositoryName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;Repository&#34;)) #set($serviceType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;Service&#34;)) #set($serviceName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;Service&#34;)) #set($serviceImplType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;ServiceImpl&#34;)) #set($serviceImplName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;ServiceImpl&#34;)) #set($apiType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;Controller&#34;)) #set($apiName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;Controller&#34;)) #set($dtoType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;DTO&#34;)) #set($dtoName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;DTO&#34;)) #set($queryType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;Query&#34;)) #set($queryName = &#34;query&#34;) #set($voType = $!tool.append($!tool.firstUpperCase($!tableInfo.name), &#34;VO&#34;)) #set($voName = $!tool.append($!tool.firstLowerCase($!tableInfo.name), &#34;VO&#34;)) ## 自定义类注解 #macro(classNotes $notes) /** * @Description $!tableInfo.obj.name $notes * @Author $!author * @Date $!time.currTime() */ #end Init 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 ##初始化区域 ##去掉表的t_前缀 $!tableInfo.setName($tool.getClassName($tableInfo.obj.name.replaceFirst(&#34;tb_&#34;,&#34;&#34;))) ## 设置业务模块名 #set($index = 0) #foreach ($element in $tableInfo.obj.name.split(&#34;_&#34;)) #set($index = $index &#43;1) #if($index == 3) #set($work = $element) #end #end #if($!{work}) ## 包.模块名 #set($workPackage = $!tool.append(&#34;.&#34;,$!{work})) ## 路径/模块名 #set($workPath = $!tool.append(&#34;/&#34;,$!{work})) ## Common-模块名 #set($workCommon = $!tool.append(&#34;-&#34;,$!{work})) #end ##参考阿里巴巴开发手册，POJO 类中布尔类型的变量，都不要加 is 前缀，否则部分框架解析会引起序列化错误 #foreach($column in $tableInfo.fullColumn) #if($column.name.startsWith(&#34;is&#34;) &amp;&amp; $column.type.equals(&#34;java.lang.Boolean&#34;)) $!column.setName($tool.firstLowerCase($column.name.substring(2))) #end #end ##实现动态排除列 #set($temp = $tool.newHashSet(&#34;testCreateTime&#34;, &#34;otherColumn&#34;)) #foreach($item in $temp) #set($newList = $tool.newArrayList()) #foreach($column in $tableInfo.fullColumn) #if($column.name!=$item) ##带有反回值的方法调用时使用$tool.call来消除返回值 $tool.call($newList.add($column)) #end #end ##重新保存 $tableInfo.setFullColumn($newList) #end ##对importList进行篡改 #set($temp = $tool.newHashSet()) #foreach($column in $tableInfo.fullColumn) #if(!$column.type.startsWith(&#34;java.lang.&#34;)) ##带有反回值的方法调用时使用$tool.call来消除返回值 $tool.call($temp.add($column.type)) #end #end ##覆盖 #set($importList = $temp) autoimport 1 2 3 4 ##自动导入包（仅导入实体属性需要的包，通常用于实体类） #foreach($import in $importList) import $!import; #end </p>
  </section>
  <footer class="entry-footer">&lt;span title=&#39;2022-02-12 15:12:48 &#43;0800 &#43;0800&#39;&gt;February 12, 2022&lt;/span&gt;&amp;nbsp;·&amp;nbsp;9 min&amp;nbsp;·&amp;nbsp;YuanPeng11</footer>
  <a class="entry-link" aria-label="post link to IDEA&#43;EasyCode实现自动生成代码" href="https://isyuanpeng.github.io/posts/tool/idea&#43;easycode%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Markdown Syntax Guide
    </h2>
  </header>
  <section class="entry-content">
    <p>This article offers a sample of basic Markdown syntax that can be used in Hugo content files, also it shows whether basic HTML elements are decorated with CSS in a Hugo theme.
...</p>
  </section>
  <footer class="entry-footer">&lt;span title=&#39;2019-03-11 00:00:00 &#43;0000 UTC&#39;&gt;March 11, 2019&lt;/span&gt;&amp;nbsp;·&amp;nbsp;3 min&amp;nbsp;·&amp;nbsp;Hugo Authors</footer>
  <a class="entry-link" aria-label="post link to Markdown Syntax Guide" href="https://isyuanpeng.github.io/posts/tech/markdown-syntax/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>
    </h2>
  </header>
  <section class="entry-content">
    <p>2022-12-10分享 回调-协程-观察者模式-SVN分支管理-缓存思考 最近开发Android中遇到的一些技术点的总结。
回调 同步 我们比较熟悉的编程模式就是同步，调用A函数后，等待A函数结束后返回结果给B函数进行处理。
1 2 3 res = request() handle(res) other() 这就是函数的同步调用，顺序执行。handle(res)的调用必须等待request()的完成。
异步 针对上面的例子，由于request请求返回的不可预见性，我们不想去等待request()的返回，直接去调用other()，这就是异步。
异步最常见的案例就是回调函数。
回调 那么对于异步的任务来说，我们想让request()请求完成后，直接去调用handle(res)方法，这时候就可以用到回调函数。
1 2 request(handle) other() 回调就是A函数和B函数，在A的某一个环节需要B自己告诉A怎么做，这就是回调。例如去商店里买东西，暂时缺货，留下电话号码就是一个回调函数，东西来货了，店员打电话通知就是一个调用回调函数。
最经典的一个理解就是 don’t call me, I’ll call you.
实际案例 在Android开发中，大量使用到了回调函数，比较经典的案例就是网络请求的调用。app作为一个进程存在于Android系统中，其可以存在多个线程，其中有一个主线程，也叫UI线程负责整个app的UI绘制。那么对于UI线程来说，一旦存在耗时操作，如网络请求调用，那么UI线程就会被阻塞，导致UI的绘制停滞。
所以在UI线程中，不能有耗时的操作出现，那么上述的回调函数就可以很好的解决这个问题。
首先我们定义一个回调函数的接口，这个接口定义在请求完成后需要做的操作。 1 2 3 4 5 6 7 8 9 10 11 12 public interface ICallBack { /** * call it when request success */ void onSuccess(); /** * call it when request fail */ void onFail(); } 其次我们定义好请求的方法，并且在传参中加入上面定义好的回调接口。 1 2 3 4 5 6 7 8 9 10 11 12 13 public void call(String url, Map&lt;String, String&gt; params, final ICallBack callBack) { // call request and use the callback to resolve result boolean isSuccess = request(url, params); if (isSuccess) { callBack.onSuccess(); } else { callBack.onFail(); } } public boolean request(String url, Map&lt;String, String&gt; params) { return true; } 最终我们在执行请求的同时去补全我们的回调逻辑 1 2 3 4 5 6 7 8 9 10 11 12 13 public void realCall() { call(&#34;&#34;, null, new ICallBack() { @Override public void onSuccess() { // success } @Override public void onFail() { // fail } }); } 协程 回调解决了异步调用的问题，但是异步回调同样存在问题，原本统一的逻辑流拆分开了，有可能会产生回调地狱的现象，毁掉里面嵌套回调。同时上下文也在一直改变了，需要去手动维护上下文，也就是手动维护状态。
...</p>
  </section>
  <footer class="entry-footer">2 min</footer>
  <a class="entry-link" aria-label="post link to " href="https://isyuanpeng.github.io/posts/tech/2022-12-09share/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="prev" href="https://isyuanpeng.github.io/posts/page/6/">« Prev Page</a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://isyuanpeng.github.io/">Isyuanpeng</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
